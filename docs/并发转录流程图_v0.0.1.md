# Whisper音频转录系统并发处理流程图

## 1. 系统整体架构流程

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面      │    │   任务管理器    │    │   GPU管理器     │
│   (Web UI)      │───▶│   (TaskManager) │───▶│   (GPUManager)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   任务队列      │    │   显存管理      │    │   GPU信息       │
│   (Queue)       │    │   (MemoryPool)  │    │   (GPU Info)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   转录处理器    │    │   任务调度器    │    │   模型加载      │
│   (Transcriber) │◀──▶│   (Scheduler)   │    │   (Whisper)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   转录结果      │    │   任务状态      │    │   显存释放      │
│   (Output)      │    │   (Status)      │    │   (Cleanup)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 2. 任务处理完整流程

```
开始
  ↓
用户提交转录任务
  ↓
任务添加到队列 (IntelligentQueueManager)
  ↓
检查当前运行任务数
  ↓
是否无运行任务? → 是 → 检查显存是否足够?
  ↓ 否
检查是否有模型加载中?
  ↓
是 → 等待模型加载完成
  ↓
否 → 检查是否可以启动新任务
  ↓
显存足够? → 是 → 检查模型是否可复用?
  ↓ 否 → 排队等待
  ↓
可以复用? → 是 → 启动复用任务（单任务模型）
  ↓ 否 → 加载新模型
  ↓
模型加载完成
  ↓
启动转录任务（单任务模型）
  ↓
转录进行中
  ↓
转录完成
  ↓
释放模型显存
  ↓
减少活跃模型计数
  ↓
检查队列是否有等待任务
  ↓
是 → 动态选择下一个可加载的模型
  ↓
否 → 等待新任务到来
  ↓
结束
```

## 3. 优化系统任务调度流程

```
开始
  ↓
任务入队
  ↓
调度器检查队列状态
  ↓
获取按模型分组的待处理任务
  ↓
为每个GPU计算最优任务批次
  ↓
检查GPU显存是否足够分配任务
  ↓
显存足够? → 是 → 动态选择下一个可加载的模型
  ↓ 否 → 任务排队等待
  ↓
分配显存并启动任务
  ↓
任务执行中
  ↓
任务完成或失败
  ↓
释放显存
  ↓
更新队列状态
  ↓
检查是否还有待处理任务
  ↓
是 → 重复调度流程
  ↓
否 → 等待新任务
  ↓
结束
```

## 4. 显存管理流程

```
开始
  ↓
获取GPU实时显存信息
  ↓
计算安全可用显存
  ↓
获取任务所需模型显存
  ↓
检查是否已有相同模型运行
  ↓
是 → 检查是否为单任务模型？→ 是 → 不可复用，排队等待
  ↓ 否
检查显存是否足够
  ↓
显存充足? → 是 → 可以加载新模型
  ↓ 否
排队等待
  ↓
显存释放后重新评估
  ↓
结束
```

## 5. 任务状态流转图

```
[Pending] → [Loading] → [Processing] → [Completed/Failed]
    ↑           ↑           ↑
    |           |           |
    └───[Resource Check]───[Release Resource]
```

## 6. 并发控制流程

```
开始
  ↓
任务提交
  ↓
检查并发数限制
  ↓
是否达到最大并发?
  ↓
是 → 加入等待队列
  ↓ 否 → 检查资源
  ↓
资源充足? → 是 → 启动任务
  ↓ 否 → 等待资源释放
  ↓
任务执行
  ↓
任务完成
  ↓
释放资源
  ↓
检查队列
  ↓
有等待任务? → 是 → 启动下一个任务
  ↓ 否 → 等待新任务
  ↓
结束
```

## 7. 优化系统核心组件交互

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   任务提交      │    │   任务调度      │    │   任务执行      │
│   (submit_task) │───▶│   (Scheduler)   │───▶│   (Processors)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   队列管理      │    │   显存预估      │    │   模型加载      │
│   (QueueMgr)    │◀──▶│   (MemoryPool)  │◀──▶│   (Whisper)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   任务状态      │    │   显存分配      │    │   转录执行      │
│   (Status)      │    │   (Allocator)   │    │   (Transcribe)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 8. 详细处理步骤

### 8.1 任务提交阶段
1. 用户通过Web界面提交转录任务
2. 任务数据被封装并添加到任务队列
3. 任务包含文件信息、模型选择、语言设置等参数

### 8.2 资源检查阶段
1. 系统检查当前运行任务数量
2. 检查GPU显存是否满足任务需求
3. 确定任务分配的GPU设备

### 8.3 任务执行阶段
1. 加载指定的Whisper模型（单任务模型）
2. 执行音频转录处理
3. 实时更新转录进度
4. 保存转录结果

### 8.4 资源释放阶段
1. 释放转录任务使用的显存
2. 清理模型缓存
3. 更新任务状态为完成
4. 检查并启动下一个等待任务（动态选择模型）
```

## 9. 错误处理流程

```
任务执行开始
  ↓
正常执行? → 是 → 任务完成
  ↓ 否
记录错误信息
  ↓
检查重试次数
  ↓
重试次数未达上限? → 是 → 任务重新排队
  ↓ 否
标记为失败任务
  ↓
更新队列状态
  ↓
结束
```

## 10. 系统优化特性

### 10.1 模型复用优化
- 优先复用已加载的相同模型
- 减少模型加载开销
- 提高系统响应速度

### 10.2 资源感知调度
- 根据显存状况动态调整任务执行
- 避免显存不足导致的阻塞
- 提高资源利用率

### 10.3 并发度控制
- 控制同时运行的模型数量（单任务模型）
- 防止GPU资源过度竞争
- 保证系统稳定性
```
