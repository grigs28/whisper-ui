# Whisper音频转录系统 版本历史

## v0.0.9 (2025-08-22)

### 重要修复
- **修复转录时间图标显示问题**：解决任务队列卡片中转录时间图标有时显示有时不显示的问题
- **优化DOM更新机制**：改进时间更新时的DOM操作，避免图标丢失
- **增强图标显示稳定性**：确保所有任务卡片中的图标始终稳定显示

### 问题解决
- 修复`updateTimeDisplays()`函数中`element.textContent`覆盖HTML结构导致图标丢失的问题
- 解决转录时间实时更新时图标被删除的问题
- 优化DOM更新逻辑，只更新时间文本内容，保留图标结构
- 增强容错处理机制，确保异常情况下图标正常显示

### 技术改进
- **精确DOM更新**：
  - 修改`updateTimeDisplays()`函数，使用`querySelector`查找时间文本元素
  - 只更新文本内容，不覆盖整个HTML结构
  - 保留图标元素，确保视觉一致性

- **容错处理机制**：
  - 添加span元素查找失败时的备选方案
  - 重新创建完整HTML结构，包含图标和时间文本
  - 确保在各种情况下图标都能正常显示

- **性能优化**：
  - 减少不必要的DOM重建操作
  - 优化更新频率，只在需要时更新
  - 保持现有DOM结构，提升更新效率

### 修复的函数
- **主要修复**：`updateTimeDisplays()` 函数
- **相关函数**：`createQueueItemElement()` 函数（保持不变）

### 修复效果
- **转录时间图标**：⏱️ 图标始终稳定显示
- **实时更新**：时间正常更新，图标不丢失
- **用户体验**：界面显示更加稳定和一致
- **视觉一致性**：所有任务卡片中的图标显示效果统一

### 测试验证
- 验证初始显示时图标正常显示
- 确认实时更新时图标保持显示
- 测试任务状态变化时图标正常
- 验证长时间运行后图标仍然显示

### 文档更新
- 创建`docs/转录时间图标显示修复报告.md`：详细记录图标显示问题修复过程
- 创建`docs/转录时间图标丢失修复报告.md`：深入分析问题根因和解决方案
- 创建`docs/任务队列函数功能说明.md`：详细说明任务队列相关函数的功能和调用关系

### 经验总结
- **DOM操作谨慎**：使用`textContent`时要考虑是否会删除HTML结构
- **精确更新**：只更新需要变化的部分，保持其他结构不变
- **容错设计**：为异常情况提供备选方案
- **测试验证**：确保修复后的功能正常工作

---

## v0.0.8 (2025-08-22)

### 重要修复
- **修复WebSocket连接错误**：解决F5刷新页面后的`write() before start_response`错误
- **实现输出格式简体中文转换**：所有输出格式（TXT、SRT、VTT、JSON）自动转换为简体中文
- **优化文件组织结构**：统一文档和日志文件管理，提升项目可维护性

### 新增功能
- **WebSocket连接优化**：添加自动重连、错误恢复、心跳检测机制
- **简体中文转换功能**：使用OpenCC库实现繁体转简体自动转换
- **测试目录结构**：创建完整的测试框架，支持WebSocket、输出格式、性能等测试
- **Cursor规则文件**：配置AI助手规则，提升开发效率和代码质量

### 问题解决
- 修复WebSocket在页面刷新时的500错误
- 解决WSGI响应头设置问题
- 实现所有输出格式的简体中文转换
- 优化文件目录结构，提升项目组织性
- 完善错误处理和日志记录机制

### 技术改进
- **WebSocket配置优化**：
  - 添加`manage_session=False`和`transports`支持
  - 实现完善的错误处理中间件
  - 优化连接确认和心跳机制
  - 改进前端重连和错误恢复逻辑

- **简体中文转换实现**：
  - 集成OpenCC库进行繁体转简体转换
  - 支持TXT、SRT、VTT、JSON所有输出格式
  - 实现转换错误处理和日志记录
  - 确保转换过程对用户透明

- **文件组织优化**：
  - 统一文档存放到`docs/`目录
  - 统一日志文件存放到`logs/`目录
  - 创建`test/`目录用于测试程序和结果
  - 更新`.gitignore`规则，优化版本控制

- **Cursor规则配置**：
  - 创建项目上下文规则文件
  - 定义编码标准和开发规范
  - 配置AI助手行为和偏好
  - 提升开发效率和代码质量

### 性能提升
- WebSocket连接稳定性显著提升，支持页面刷新自动重连
- 输出格式转换性能优化，转换过程几乎无感知
- 项目文件组织更加清晰，便于维护和扩展
- AI助手代码生成质量提升，更符合项目规范

### 用户体验改进
- 页面刷新后WebSocket连接自动恢复，无需手动重连
- 所有输出格式自动转换为简体中文，提升文件可读性
- 项目结构更加清晰，便于新开发者理解
- 开发工具配置完善，提升开发体验

### 测试验证
- 通过WebSocket连接测试验证修复效果
- 验证所有输出格式的简体中文转换功能
- 确认文件组织结构优化效果
- 测试Cursor规则文件的配置效果

### 文档更新
- 创建`docs/WEBSOCKET_FIX_SUMMARY.md`：WebSocket修复详细说明
- 创建`docs/SIMPLIFIED_CHINESE_OUTPUT_SUMMARY.md`：简体中文转换功能说明
- 创建`docs/PROJECT_RULES.md`：项目规则文件
- 创建`test/README.md`：测试目录说明
- 创建`.cursor/rules/`：Cursor规则文件

---

## v0.0.7 (2025-08-22)

### 重要修复
- **修复GPU显存池死锁问题**：解决任务卡在pending状态无法处理的关键bug
- **优化显存分配机制**：修复available_memory属性的递归锁问题
- **增强系统启动验证**：确保调度器正确启动并运行
- **完善错误处理机制**：添加系统启动失败时的优雅退出
- **修复批量任务调度循环问题**：解决多任务处理时的显存分配循环bug
- **完善转录结果列表框自动刷新**：确保转录完成后前端自动更新结果列表

### 问题解决
- 修复`available_memory`属性调用`free_memory`导致的死锁
- 修复`allocate`方法中调用`available_memory`时的锁冲突
- 修复`release`方法中的递归锁问题
- 解决任务调度器无法正常处理待处理任务的问题
- 修复批量任务调度中显存不足时的循环释放问题
- 优化前端异步刷新机制，确保转录结果及时显示

### 技术改进
- 重构GPU显存池的锁管理机制，避免递归锁
- 优化显存分配和释放的并发安全性
- 增强main.py中的系统启动验证逻辑
- 完善调度器状态检查和错误处理
- 改进批量任务调度逻辑，支持单个任务执行
- 增强前端文件列表刷新机制，添加调试日志和错误处理

### 性能提升
- 显存分配响应时间从卡死状态恢复到正常（<1秒）
- 任务调度效率显著提升，无卡顿现象
- 系统稳定性大幅改善，支持连续任务处理
- 多任务并发处理能力显著提升
- 前端响应速度优化，转录结果实时更新

### 测试验证
- 通过基础GPU显存池测试验证修复效果
- 确认转录任务完整流程正常工作
- 验证显存分配、任务处理、结果保存全流程正常
- 成功测试4个文件并发转录，无循环问题
- 验证转录结果列表框自动刷新功能正常工作

---

## v0.0.6 (2025-08-20)

### 新增功能
- 完善日志系统，实现重要信息同时发送到index运行日志、log文件、WebSocket和终端
- 优化日志记录机制，支持多目标日志输出
- 增强系统监控和调试能力

### 改进
- 统一日志记录接口，提高日志管理效率
- 完善前端日志显示功能
- 优化WebSocket日志推送机制

### 技术改进
- 更新logger.py，增强多目标日志处理能力
- 完善前端statusLogger.js，改进日志显示和推送功能
- 优化各核心模块的日志记录实现

---

## v0.0.5 (2025-08-15)

### 新增功能
- 集成NVIDIA ML库获取精确GPU信息
- 实现显存预估池机制，支持预估→实测→调整的闭环管理
- 添加显存占用上限控制，确保使用不超过总显存的90%
- 支持多GPU并发处理，提高系统整体效率
- 实现GPU任务调度算法，优化资源分配

### 改进
- 重构GPU管理器，增强显存监控能力
- 优化显存分配逻辑，提高资源利用率
- 改进任务队列管理，支持优先级调度
- 完善显存校准机制，提高预估准确性

### 配置变更
- 新增MAX_TASKS_PER_GPU配置项，限制单GPU并发任务数
- 新增MEMORY_CONFIDENCE_FACTOR配置项，用于显存预估置信因子（默认1.0）
- 新增CALIBRATION_SAMPLE_SIZE配置项，控制校准样本数量
- 调整RESERVED_MEMORY默认值为0.0GB

### 新增配置参数详解
#### MEMORY_CONFIDENCE_FACTOR
- **作用**：显存校准置信因子，用于动态调整模型显存预估的准确性
- **默认值**：1.0
- **推荐范围**：0.8-1.5
- **计算公式**：最终显存需求 = 基础显存预估 × 时长因子 × MEMORY_CONFIDENCE_FACTOR
- **配置位置**：config.py 第134行，支持环境变量覆盖
- **使用场景**：
  - 生产环境：1.0（平衡安全性和效率）
  - 高负载环境：1.2（增加安全边际）
  - 测试环境：0.9（提高资源利用率）
  - 资源受限环境：0.8（最大化利用率）

### 技术改进
- 更新gpu_manager.py，集成pynvml库
- 完善memory_manager.py，实现显存预估池机制
- 优化optimized_whisper.py，支持多GPU任务调度
- 更新config.py，添加新的显存管理配置项

---

## v0.0.4 (2025-08-14)

### 新增功能
- 添加 turbo 模型支持，平衡速度和精度
- 新增 FFmpeg 系统依赖安装指南
- 支持多操作系统 FFmpeg 安装说明（openEuler、Ubuntu、Debian、Arch Linux、macOS、Windows）
- 完善模型内存需求显示功能

### 改进
- 修复模型内存需求显示为"--"的问题
- 更新所有模型的显存需求配置
- 完善前端模型选择器的内存需求映射
- 优化 README 文档，添加详细的环境配置说明
- 设置 turbo 为默认推荐模型

### 技术改进
- 更新 main.py 中的 WHISPER_MODELS 列表
- 完善 gpuMonitor.js 和 uiManager.js 中的模型内存需求配置
- 同步更新 .env 和 .env.sample 配置文件
- 更新相关文档（MEMORY_CALCULATION_GUIDE.md、USAGE_INSTRUCTIONS.md）

---

## v0.0.3 (2025-01-XX)

### 新增功能
- 添加模型下载进度提示弹窗
- 实现实时下载进度显示
- 支持模型下载状态监控
- 增加WebSocket进度推送功能

### 改进
- 调整弹窗样式和大小，与播放器保持一致
- 优化模型存储路径配置
- 修复模型下载路径问题
- 完善进度捕获和显示机制

### 配置变更
- 更新MODEL_BASE_PATH为/opt/models/openai
- 修正模型下载目录结构为whisper-{模型名称}
- 优化模型路径管理逻辑

---

## v0.0.2 (2025-01-XX)

### 新增功能
- 增加 Markdown 解析模块
- 支持版本历史显示
- 优化音频播放器界面
- 添加浮动播放器文件名显示

### 改进
- 重构音频播放器实现
- 移除重复代码
- 提升用户体验

---

## v0.0.1 (2025-08-13)

### 项目描述
改进版Whisper音频转录系统，支持多文件上传和自动选择功能

### 主要功能
- 支持多文件同时上传
- 自动选择上传的文件
- 支持10种常用语言转录
- GPU加速转录
- 实时任务监控

### 改进内容
- 优化文件管理器实现
- 增强多文件处理能力
- 改进用户界面交互
- 完善转录语言限制